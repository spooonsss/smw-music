<!doctype html>
<html>

<head>
    <meta charset="UTF-8">

    <link rel="icon" href="favicon.ico" type="image/x-icon">

    <title></title>

    <script>

        window.addEventListener("load", function () {
            function sendData() {
                const XHR = new XMLHttpRequest();
                const FD = new FormData(form);

                var results_parent = document.getElementById("results");
                results_parent.innerHTML = '';
                var results = document.createElement('div');
                results_parent.appendChild(results);
                var level_results_parent = document.getElementById("level_results");
                level_results_parent.innerHTML = '';
                var level_results = document.createElement('div');
                level_results_parent.appendChild(level_results);
                var img = document.createElement('img');
                img.setAttribute('src', 'ballandchain.gif');
                results.appendChild(img);

                var song_data_done = false;
                var level_songs = undefined;
                var song_divs = {};
                var set_level_data = () => {
                    Object.getOwnPropertyNames(level_songs).forEach(song => {
                        var div = song_divs[song];
                        if (div) {
                            var rooms = document.createElement('span');
                            rooms.innerText = ' (Used in ' + level_songs[song].map(x => x.toString(16)).join(', ') + ')';
                            div.appendChild(rooms);
                        }
                    });
                };

                fetch('https://bkx8dos410.execute-api.us-east-1.amazonaws.com/dev/get_song_data', {
                    // fetch('http://127.0.0.1:5000/get_song_data', {
                    method: 'POST',
                    body: FD
                })
                .then(response => {
                    if (!response.ok) {
                        return response.text().then(text => { throw text; });
                    }
                    return response.json();
                })
                .then(data => {
                    results.innerHTML = '';
                    data['songs_'].forEach(function (song) {
                        var div = document.createElement('div');
                        // var songid = /\w+/.exec(song.name)[0];
                        song_divs[song.num] = div;
                        var num = document.createElement('span');
                        num.innerText = song.num.toString(16) + ' ';
                        div.appendChild(num);
                        if (song.url) {
                            var a = document.createElement('a');
                            a.setAttribute('href', song.url)
                            a.innerText = song.name;
                            div.appendChild(a);
                        } else {
                            var name = document.createElement('span');
                            name.innerText = song.name;
                            div.appendChild(name);
                        }
                        results.appendChild(div);
                    });
                    song_data_done = true;
                    if (level_songs) {
                        set_level_data();
                    }
                })
                .catch(error => {
                    results.innerHTML = '';
                    results.innerHTML = error;
                    song_data_done = true;
                });


                // fetch('http://127.0.0.1:5000/get_level_songs', {
                fetch('https://bkx8dos410.execute-api.us-east-1.amazonaws.com/dev/get_level_songs', {
                    method: 'POST',
                    body: FD
                })
                .then(response => {
                    if (!response.ok) {
                        return response.text().then(text => { throw text; });
                    }
                    return response.json();
                })
                .then(data => {
                    // level_results.innerHTML = JSON.stringify(data);
                    level_songs = data;
                    if (song_data_done === true) {
                        set_level_data();
                    }
                })
                .catch(error => {
                    level_results.innerHTML = error;
                });
            }

            const form = document.getElementById("form");
            form.addEventListener("submit", function (event) {
                event.preventDefault();

                if (document.getElementById("fileInput").value) {
                    sendData();
                }
            });

            document.getElementById("fileInput").addEventListener('change', (event) => {
                //document.getElementById("form").submit();
                if (document.getElementById("fileInput").value) {
                    sendData();
                }
            });

        });


    </script>
    <style>
    </style>
</head>

<body bgcolor="#F3FBFF" style="margin: 0">
    <div style="padding: 2em; ">
        <form id="form">
            <p>
                <label for="fileInput">headered SMW .smc file or .bps:</label>
                <input id="fileInput" name="file" type="file">
            </p>
        </form>
        <div id="results"></div>
        <div id="level_results"></div>
        <div style="height: 5em"></div>
    </div>

    <div
        style="position: fixed; padding-left: 5em; padding-bottom: 0.5em; padding-top: 0.5em; bottom: 0; width: 100%; background: #A0D4FF">
        Remade by spooonsss based on original code by dtothefourth ❤️<br />
        <img src="ballandchain.gif" style="display: none;">
    </div>
</body>

</html>